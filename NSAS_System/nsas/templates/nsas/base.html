{% extends 'nsas/base_map.html' %}
{% block title %}Display map{% endblock %}

{% block header %}

<style>
    .ol-popup {
        position: absolute;
        background-color: white;
        -webkit-filter: drop-shadow(0 1px 4px rgba(0, 0, 0, 0.2));
        filter: drop-shadow(0 1px 4px rgba(0, 0, 0, 0.2));
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #cccccc;
        bottom: 12px;
        left: -50px;
        min-width: 180px;
    }

    .ol-popup:after,
    .ol-popup:before {
        top: 100%;
        border: solid transparent;
        content: " ";
        height: 0;
        width: 0;
        position: absolute;
        pointer-events: none;
    }

    .ol-popup:after {
        border-top-color: white;
        border-width: 10px;
        left: 48px;
        margin-left: -10px;
    }

    .ol-popup:before {
        border-top-color: #cccccc;
        border-width: 11px;
        left: 48px;
        margin-left: -11px;
    }

    .ol-popup-closer {
        text-decoration: none;
        position: absolute;
        top: 2px;
        right: 8px;
    }

    .ol-popup-closer:after {
        content: "✖";
    }
</style>

{% load static %}

{% endblock %}
{% block body %}

<style>
    .navbar-inverse-custom {
        background-color: #ffffff;
        border-color: #ffffff
    }

    .navbar-toggle-custom {
        background-color: #222;
        border-color: #080808;
    }
</style>
<br />
<div class="container-fluid map-container">
    <div class="row">
        <div class="col-md-3" id="id_searchTabs">
            <nav class="navbar navbar-inverse-custom ">
                <div class="container">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle navbar-toggle-custom collapsed"
                            data-toggle="collapse" data-target="#search_navbar" aria-expanded="false"
                            aria-controls="search_navbar">
                            <i class="fa fa-navicon fa-lg"></i>
                        </button>
                    </div>
                    <div id="search_navbar" class="navbar-collapse collapse">
                        <div class="form-group" id="id_tabs">
                            <ul class="nav nav-tabs">
                                <li class="active"><a href="#locationName" data-toggle="tab" aria-expanded="true"
                                        onclick="mapSingleClickListener()">Location</a></li>
                                <li class=""><a href="#route" data-toggle="tab" aria-expanded="false"
                                        onclick="mapClickListener()">Route</a></li>
                            </ul>
                            <div id="myTabContent" class="tab-content">
                                <div class="tab-pane fade active in" id="locationName">
                                    <h3> Find a location</h3>
                                    <input type="text" id="id_search" class="form-control"
                                        placeholder="Seach place name" />
                                    <input type="hidden" id="link_origin_id" />
                                    <div class="form-group col-sm-10" id="id_searchByLocationType">
                                    </div>
                                    <div class="col-sm-5">
                                        <button id="id_addMoreLocationType" class="btn btn-info">More...</button>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="route">
                                    <div class="form-group">
                                        <span class="col-sm-2"><img id="startLocation"
                                                style="width:1.75rem;height:2.313rem;"
                                                src="{% static 'nsas/images/locationA.png' %}"></span>
                                        <div class="col-sm-10">
                                            <input type="text" id="searchStart" class="form-control"
                                                placeholder="Start name" />
                                        </div>
                                    </div>
                                    <br />
                                    <br />
                                    <div class="form-group">
                                        <span class="col-sm-2"><img id="startLocation"
                                                style="width:1.75rem;height:2.313rem;"
                                                src="{% static 'nsas/images/locationB.png' %}"></span>
                                        <div class="col-sm-10">
                                            <input type="text" id="searchEnd" class="form-control"
                                                placeholder="Destination name" />
                                        </div>
                                    </div>
                                    <br />
                                    <br />
                                    <div class="form-group">
                                        <div class="col-sm-5">
                                            <button id="findRoute" class="btn btn-info">Find Route</button>
                                        </div>
                                        <div class="col-sm-5">
                                            <button id="clear" class="btn btn-info">Clear</button>
                                        </div>
                                    </div>
                                    <br />
                                    <br />
                                    <div class="form-group" id="id_divDistanceTime">
                                        <div class="alert alert-dismissible alert-info">
                                            <button type="button" class="close" data-dismiss="alert">×</button>
                                            <strong>Directions</strong>
                                            <br />
                                            <br />
                                            <p><span id="id_spanDistanceTime">Distance:0km Time:0:00 </span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
        <div class="col-md-9" id="id_map">
            <form class="form-inline" style="display: none">
                <label>Geometry type &nbsp;</label>
                <select id="type">
                    <option value="Point">Point</option>
                </select>
            </form>
            <div id="map" class="map" style="min-height: 380px;"></div>
            <div id="popup" class="ol-popup">
                <a href="#" id="popup-closer" class="ol-popup-closer"></a>
                <div id="popup-content"></div>
            </div>
            <div id="wrapper">
                <div id="location" class="marker"><span class="icon-arrow-up"></span></div>
                <div id="scale"></div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">

    var selectedfeature = null;
    var selectedPoint = 0;
    var pureCoverage = false;
    var startLocationTypeValue = 0;
    var endLocationTypeValue = 6;
    // if this is just a coverage or a group of them, disable a few items,
    // and default to jpeg format
    var format = 'image/png';
    var bounds = [38.6365928649902, 8.83087158203125, 38.9067764282227, 9.09962368011475];

    var mousePositionControl = new ol.control.MousePosition({
        className: 'custom-mouse-position',
        target: document.getElementById('location'),
        coordinateFormat: ol.coordinate.createStringXY(5),
        undefinedHTML: '&nbsp;'
    });
    var osmLayer = new ol.layer.Tile({
        title: "OSM",
        source: new ol.source.OSM()
    });

    var tiled = new ol.layer.Tile({
        source: new ol.source.TileWMS({
            url: 'http://localhost:8080/geoserver/NSAS/wms',
            params: {
                'FORMAT': format,
                'VERSION': '1.1.1',
                tiled: true,
                LAYERS: 'NSAS:nifassilk_sub_city_aoi',
                STYLES: ''
            }
        })
    });

    var vectorWorda = new ol.layer.Vector({
        source: new ol.source.Vector({
            url: 'http://localhost:8080/geoserver/NSAS/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=NSAS:nifassilk_sub_city_aoi&outputFormat=application/json',
            format: new ol.format.GeoJSON()
        }),
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: '#a79191',
                width: 2
            }),
            fill: new ol.style.Fill({
                color: 'transparent'
            })
        })
    });


    var vectorlowIncomeSettlement = new ol.layer.Tile({
        title: "Low income settlement block",
        source: new ol.source.TileWMS({
            url: 'http://www.ethionsdi.gov.et/geoserver/geonode/wms',
            params: {
                'FORMAT': format,
                'VERSION': '1.1.1',
                tiled: true,
                LAYERS: 'geonode:addis_ababa_saftinate_block_1',
                STYLES: ''
            }
        })
    });

    var selectedTab = "Location";
    var locationValue = new Array();
    var locationList = new Array();
    var locationTypeValue = new Array();
    var locationTypeList = new Array();
    var uniqueLoctaionTypeList = new Array();
    var locationListJson = JSON.stringify(locationList);
    var locationTypeListJson = JSON.stringify(locationTypeList);

    var locationTypeVectorSource = new ol.source.Vector({
        format: new ol.format.GeoJSON()
    });
    var locationTypeVectorLayer = new ol.layer.Vector();
    var routeVectorSource = new ol.source.Vector();
    var routeVectorLayer = new ol.layer.Vector();

    // GeoJSON layer
    function loadLocationNames() {
        var url = "http://localhost:8080/geoserver/NSAS/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=NSAS:bldg_final_v7&outputFormat=text/javascript&format_options=callback:loadFeatures";
        $.ajax({
            url: url,
            dataType: 'jsonp'
        });
    }
    var loadFeatures = function (response) {
        var vectorSource = new ol.source.Vector({
            format: new ol.format.GeoJSON()
        });
        var features = (new ol.format.GeoJSON()).readFeatures(response);
        vectorSource.addFeatures(features);
        vectorSource.forEachFeature(function (feature) {

            locationValue = { 'label': feature.get('bldgname_e'), "value": feature.getGeometry().getCoordinates() }
            locationList.push(locationValue);
            locationTypeValue = { 'label': feature.get('maj_lu'), "value": feature.get('maj_lu') }
            locationTypeList.push(locationTypeValue);

        });
        locationList.sort(GetSortOrder("label")); //Pass the attribute to be sorted on
        locationListJson = JSON.stringify(locationList);
        locationTypeListJson = JSON.stringify(locationTypeList);
        var lookup = {};
        var items = JSON.parse(locationTypeListJson);
        var result = [];
        for (var item, i = 0; item = items[i++];) {
            var type = item.label;
            if (!(type in lookup)) {
                lookup[type] = 1;
                result.push(type);
                uniqueLoctaionTypeList.push(item);
            }
        }
        uniqueLoctaionTypeList.sort(GetSortOrder("label")); //Pass the attribute to be sorted on
        addLocationType();
    };
    //Comparer Function
    function GetSortOrder(prop) {
        return function (a, b) {
            if (a[prop] > b[prop]) {
                return 1;
            } else if (a[prop] < b[prop]) {
                return -1;
            }
            return 0;
        };
    }
    var addLocationTypeButton = document.getElementById('id_addMoreLocationType');
    addLocationTypeButton.addEventListener('click', function (event) {
        addLocationType();
    });
    function addLocationType() {
        for (var i = startLocationTypeValue; i < uniqueLoctaionTypeList.length && i <= endLocationTypeValue; i++) {
            createNewCheckbox(uniqueLoctaionTypeList[i].label, uniqueLoctaionTypeList[i].value);
        }
        startLocationTypeValue = endLocationTypeValue + 1;
        endLocationTypeValue = endLocationTypeValue + 6;
    }

    var removedName = '';
    function createNewCheckbox(name, id) {
        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.name = name;

        checkbox.id = "id_Checkbox_" + id;
        checkbox.value = id;

        document.getElementById("id_searchByLocationType").appendChild(checkbox);
        $('input[type=checkbox]').addClass('custom-control-input');
        document.getElementById(checkbox.id).onclick = function () {
            if (this.checked) {
                addLocationTypeOnMap(this.value)
            }
            else {
                var typevalue = "" + this.value;
                removedName = this.value;
                locationTypeVectorSource.forEachFeature(function (feature) {

                    var featurevalue = "" + feature.get('type');

                    if (featurevalue.localeCompare(typevalue) == 0) {

                        locationTypeVectorSource.removeFeature(feature);
                    }
                });
                map.removeLayer(locationTypeVectorLayer);
                document.getElementById("id_label_" + this.value).innerHTML = this.value;
            }
        };

        var label = document.createElement('label');
        label.setAttribute('for', id);

        label.id = "id_label_" + id;

        label.innerHTML = id;

        document.getElementById("id_searchByLocationType").appendChild(label);

        document.getElementById("id_searchByLocationType").appendChild(document.createElement("br"));

    }

    var tiledRoads = new ol.layer.Tile({
        visible: true,
        source: new ol.source.TileWMS({
            url: 'http://localhost:8080/geoserver/SID/wms',
            params: {
                'FORMAT': format,
                'VERSION': '1.1.1',
                tiled: true,
                STYLES: '',
                LAYERS: 'SID:Road_Line_V6'
            }
        })
    });

    var roadPoly = new ol.layer.Tile({
        visible: true,
        source: new ol.source.TileWMS({
            url: 'http://localhost:8080/geoserver/NSAS/wms',
            params: {
                'FORMAT': format,
                'VERSION': '1.1.1',
                tiled: true,
                STYLES: '',
                LAYERS: 'NSAS:rd_polygone_v2'
            }
        })
    });

    var projection = new ol.proj.Projection({
        code: 'EPSG:4326',
        units: 'degrees',
        axisOrientation: 'neu'
    });

    var view = new ol.View({
        projection: projection
    });

    var map = new ol.Map({
        controls: ol.control.defaults({ attribution: false }).extend([mousePositionControl]),
        target: 'map',
        layers: [osmLayer, tiled, vectorWorda, roadPoly, tiledRoads],
        view: view
    });
    $(function () {
        loadSignPostType();
        loadLocationNames();
    });

    var sign_post_vector;
    function loadSignPostType() {
        var url = "http://localhost:8080/geoserver/NSAS/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=NSAS:sign_posts_v1&outputFormat=text/javascript&format_options=callback:loadSignPostFeatures";
        $.ajax({
            url: url,
            dataType: 'jsonp'

        });
    }
    var loadSignPostFeatures = function (response) {
        sign_post_vector = new ol.layer.Vector();
        var vectorSource = new ol.source.Vector(
            {
                format: new ol.format.GeoJSON()
            });
        var features = (new ol.format.GeoJSON()).readFeatures(response);
        vectorSource.addFeatures(features);
        var style_heightLimitSign = new ol.style.Style({
            image: new ol.style.Circle({
                radius: 5,
                fill: new ol.style.Fill({
                    color: '#2baacd'
                })
            })
        });
        var style_square = new ol.style.Style({
            image: new ol.style.Circle({
                radius: 5,
                fill: new ol.style.Fill({
                    color: '#f5fefe',
                    width: 1
                }),
                stroke: new ol.style.Stroke({
                    color: '#19ea5f',
                    width: 4
                })
            })
        });
        var style_traficLight = new ol.style.Style({
            image: new ol.style.Circle({
                radius: 5,
                fill: new ol.style.Fill({
                    color: '#effa10',
                    width: 1
                }),
                stroke: new ol.style.Stroke({
                    color: '#ea0404',
                    width: 4
                })
            })
        });
        sign_post_vector = new ol.layer.Vector({
            source: vectorSource,
        });
        vectorSource.forEachFeature(function (feature) {
            var signPostValue = feature.get('type');
            if (signPostValue == 'Height Limit Sign') {
                feature.setStyle(style_heightLimitSign);
            }
            else if (signPostValue == 'Square') {
                feature.setStyle(style_square);
            }
            else {
                feature.setStyle(style_traficLight);
            }
        });
        map.addLayer(sign_post_vector);
    };

    // var layerSwitcher = new ol.control.LayerSwitcher();
    // map.addControl(layerSwitcher);
    // sign_post_vector.getSource().on('change', function (evt) {
    //     loadLocationNames();
    // });

    var params = {
        LAYERS: 'NSAS:road_line_v6_routing',
        FORMAT: 'image/png',
        'VERSION': '1.3.0'
    };

    // The "start" and "destination" features.
    var startPoint = new ol.Feature();
    var destPoint = new ol.Feature();
    // The vector layer used to display the "start" and "destination" features.
    var vectorLayer = new ol.layer.Vector({
        displayInLayerSwitcher: false,
        title: "start & destination points",
        source: new ol.source.Vector({
            features: [startPoint, destPoint]
        }),
        style: new ol.style.Style({

            image: new ol.style.Circle({
                radius: 8,
                fill: new ol.style.Fill({
                    color: 'red'
                })
            })
        })
    });


    $(document).ready(function () {

        $('#id_search').autocomplete({
            source: function (request, response) {

                var results = $.ui.autocomplete.filter(locationList, request.term);

                var top_suggestions = $.grep(results, function (n, i) {
                    return (n.label.substr(0, request.term.length).toLowerCase() == request.term.toLowerCase());
                });

                var merged_results = $.merge(top_suggestions, results);

                var final_results = $.unique(merged_results);

                response(final_results);
            },
            // This updates the textfield when you move the updown the suggestions list, with your keyboard. In our case it will reflect the same value that you see in the     suggestions which is the person.given_name.
            focus: function (event, ui) {
                $('#id_search').val(ui.item.label);

            },
            // Once a value in the drop down list is selected, do the following:
            select: function (event, ui) {

                var locationNamePoint = new ol.Feature();
                // Remove the result layer.
                var layersToRemove = [];
                map.getLayers().forEach(function (layer) {
                    if (layer.get('name') === 'locationNameVectorLayer') {
                        layersToRemove.push(layer);
                    }
                });

                var len = layersToRemove.length;
                for (var i = 0; i < len; i++) {
                    map.removeLayer(layersToRemove[i]);
                }
                // place the person.given_name value into the textfield called 'select_origin'...
                $('#id_search').val(ui.item.label);
                // and place the person.id into the hidden textfield called 'link_origin_id'.
                $('#link_origin_id').val(ui.item.value);

                var latlonvalues = ui.item.value.toString().split(",");
                var lat = parseFloat(latlonvalues[0]);
                var lon = parseFloat(latlonvalues[1]);
                var featureName = latlonvalues[2].split(":")[1];
                var symbolUrl = latlonvalues[3].split(":")[1];
                var point = [lat, lon];
                var p = new ol.geom.Point(point);
                locationNamePoint.setGeometry(p);

                var pointAttributes = { 'name': featureName }

                locationNamePoint.setProperties(pointAttributes);

                var style = null;
                if (symbolUrl) {
                    style = new ol.style.Style(
                        {
                            image: new ol.style.Icon(
                                {
                                    anchor: [0, 0],
                                    size: [25, 25],
                                    scale: 1,
                                    src: symbolUrl
                                })
                        });
                }
                else {
                    style = new ol.style.Style(
                        {
                            image: new ol.style.Circle(
                                {
                                    radius: 8,
                                    fill: new ol.style.Fill({ color: 'green' })
                                })
                        });
                }
                // The vector layer used to display the "start" and "destination" features.
                var locationNameVectorLayer = new ol.layer.Vector({
                    displayInLayerSwitcher: false,
                    title: "place name result ",
                    source: new ol.source.Vector({
                        features: [locationNamePoint]
                    }),
                    style: style
                });

                map.addLayer(locationNameVectorLayer);

                locationNameVectorLayer.set('name', 'locationNameVectorLayer');

                map.getView().animate({ center: point });
                return false;
            }
        });
        $('#searchStart').autocomplete({
            source: function (request, response) {

                var results = $.ui.autocomplete.filter(locationList, request.term);

                var top_suggestions = $.grep(results, function (n, i) {
                    return (n.label.substr(0, request.term.length).toLowerCase() == request.term.toLowerCase());
                });

                var merged_results = $.merge(top_suggestions, results);

                var final_results = $.unique(merged_results);

                response(final_results);
            },
            // This updates the textfield when you move the updown the suggestions list, with your keyboard. In our case it will reflect the same value that you see in the     suggestions which is the person.given_name.
            focus: function (event, ui) {
                $('#searchStart').val(ui.item.label);
            },
            // Once a value in the drop down list is selected, do the following:
            select: function (event, ui) {

                // place the person.given_name value into the textfield called 'select_origin'...
                $('#searchStart').val(ui.item.label);
                // and place the person.id into the hidden textfield called 'link_origin_id'.
                $('#link_origin_id').val(ui.item.value);

                var latlon = ui.item.value.toString().split(",");
                var lat = parseFloat(latlon[0]);
                var lon = parseFloat(latlon[1]);
                var point = [lat, lon];
                var p = new ol.geom.Point(point);
                startPoint.setGeometry(p);
                map.addLayer(vectorLayer);
                map.getView().animate({ center: point });
                return false;
            }
        });
        $('#searchEnd').autocomplete({
            source: function (request, response) {

                var results = $.ui.autocomplete.filter(locationList, request.term);

                var top_suggestions = $.grep(results, function (n, i) {
                    return (n.label.substr(0, request.term.length).toLowerCase() == request.term.toLowerCase());
                });

                var merged_results = $.merge(top_suggestions, results);

                var final_results = $.unique(merged_results);

                response(final_results);
            },
            // This updates the textfield when you move the updown the suggestions list, with your keyboard. In our case it will reflect the same value that you see in the     suggestions which is the person.given_name.
            focus: function (event, ui) {
                $('#searchEnd').val(ui.item.label);
            },
            // Once a value in the drop down list is selected, do the following:
            select: function (event, ui) {

                // place the person.given_name value into the textfield called 'select_origin'...
                $('#searchEnd').val(ui.item.label);
                // and place the person.id into the hidden textfield called 'link_origin_id'.
                $('#link_origin_id').val(ui.item.value);

                var latlon = ui.item.value.toString().split(",");
                var lat = parseFloat(latlon[0]);
                var lon = parseFloat(latlon[1]);
                var point = [lat, lon];
                var p = new ol.geom.Point(point);
                destPoint.setGeometry(p);
                map.getView().animate({ center: point });
                return false;
            }
        });
    });

    var container = document.getElementById('popup');
    var content = document.getElementById('popup-content');
    var closer = document.getElementById('popup-closer');

    var overlay = new ol.Overlay(({
        element: container,
        autoPan: true,
        autoPanAnimation: {
            duration: 250
        }
    }));

    $(function () {

        var buttonToggle = '<button style="background-color: rgba(0,60,136,.5)"  type="button" title="Toggle" id="id_toggle"><<</button>';

        $(buttonToggle).appendTo(".ol-zoom");

        var toggleButton = document.getElementById('id_toggle');
        toggleButton.addEventListener('click', function (event) {

            $('#id_tabs').toggle();

            if (toggleButton.innerText === ">>") {

                $('#id_map').removeClass('col-md-12');
                $('#id_searchTabs').addClass('col-md-3');
                $('#id_map').addClass('col-md-9');
                toggleButton.innerText = "<<";
            }
            else if (toggleButton.innerText === "<<") {
                $('#id_searchTabs').removeClass('col-md-3');
                $('#id_map').removeClass('col-md-9');

                $('#id_map').addClass('col-md-12');
                toggleButton.innerText = ">>";
            }
        });

        var buttongeoCurrentLocation = '<button style="background-color: rgba(0,60,136,.5)"  type="button" title="Show My Location" id="id_geoCurrentLocation"><span class="glyphicon glyphicon-map-marker"></span></button>';

        $(buttongeoCurrentLocation).appendTo(".ol-zoom");

        var toggleButtonCurrentLocation = document.getElementById('id_geoCurrentLocation');
        toggleButtonCurrentLocation.addEventListener('click', function (event) {

            GeoCurrentLocation();

        });

        mapSingleClickListener();
        $('#id_divDistanceTime').hide();
    });

    function GeoCurrentLocation() {

        var geolocation = new ol.Geolocation({
            projection: projection,
            tracking: true
        });

        // add an empty iconFeature to the source of the layer
        var iconFeature = new ol.Feature();
        var iconSource = new ol.source.Vector({
            features: [iconFeature]
        });
        var iconLayer = new ol.layer.Vector({
            source: iconSource
        });
        map.addLayer(iconLayer);
        geolocation.on('change', function () {
            var pos = geolocation.getPosition();
            iconFeature.setGeometry(new ol.geom.Point(pos));
            startPoint.setGeometry(new ol.geom.Point(pos));
            document.getElementById('searchStart').value = pos;
            map.addLayer(vectorLayer);
            view.setCenter(pos);
            view.setZoom(18);
            if (selectedPoint == 0) {
                selectedPoint = selectedPoint + 1;
            }
        });
    }
    function mapSingleClickListener() {
        selectedTab = "Location";
        closer.onclick = function () {
            overlay.setPosition(undefined);
            closer.blur();
            return false;
        };
        if (selectedPoint == 2) {
            map.removeLayer(result);
            startPoint.setGeometry(null);
            destPoint.setGeometry(null);
            selectedPoint = 0;
        }

        map.removeLayer(vectorLayer);
        map.addOverlay(overlay);
        map.on('singleclick', function (evt) {
            if (selectedTab === "Location") {
                var feature = map.forEachFeatureAtPixel(evt.pixel,
                    function (feature) {
                        return feature;
                    });
                if (feature) {
                    var coordinate = feature.getGeometry().getCoordinates();

                    var items = '';
                    if (feature.get('bldgname_e')) {
                        items = feature.get('bldgname_e')
                    }
                    else if (feature.get('name')) {
                        items = feature.get('name')
                    }
                    console.log(items)
                    content.innerHTML = items;
                    overlay.setPosition(coordinate);
                }
            }
        });
    }

    function mapClickListener() {
        selectedTab = "Route";
        map.removeOverlay(overlay);
        // Register a map click listener.
        map.on('click', function (event) {
            if (selectedTab === "Route") {
                if (startPoint.getGeometry() == null) {
                    map.addLayer(vectorLayer);
                    startPoint.setGeometry(new ol.geom.Point(event.coordinate));
                    selectedPoint = selectedPoint + 1;
                }
                else if (destPoint.getGeometry() == null) {
                    destPoint.setGeometry(new ol.geom.Point(event.coordinate));
                    selectedPoint = selectedPoint + 1;
                }

                if (selectedPoint == 2) {
                    var startCoord = startPoint.getGeometry().getCoordinates();
                    var destCoord = destPoint.getGeometry().getCoordinates();
                    var viewparams = [
                        'x1:' + startCoord[0], 'y1:' + startCoord[1],
                        'x2:' + destCoord[0], 'y2:' + destCoord[1]
                    ];
                    params.viewparams = viewparams.join(';');
                    result = new ol.layer.Image({
                        displayInLayerSwitcher: false,
                        title: "routing result",
                        source: new ol.source.ImageWMS({
                            ratio: 1,
                            url: 'http://localhost:8080/geoserver/NSAS/wms',
                            params: params
                        })
                    });
                    map.addLayer(result);
                    routeDistance();

                    var coord = event.coordinate;

                } else {
                    var feature = map.forEachFeatureAtPixel(event.pixel,
                        function (feature) {
                            return feature;
                        });
                    if (feature) {
                        //var coordinate = feature.getGeometry().getCoordinates();

                        // overlay.setPosition(coordinate);
                    }

                }
            }
        });
    }
    var clearButton = document.getElementById('clear');
    clearButton.addEventListener('click', function (event) {
        // Reset the "start" and "destination" features.
        document.getElementById('searchStart').value = '';
        document.getElementById('searchEnd').value = '';
        startPoint.setGeometry(null);
        destPoint.setGeometry(null);

        document.getElementById('id_spanDistanceTime').innerHTML = "Distance:0km  Time:0:00";
        $('#id_divDistanceTime').hide();
        // Remove the result layer.
        if (selectedPoint == 2) {
            map.removeLayer(result);
        }
        map.removeLayer(vectorLayer);
        selectedPoint = 0;
    });

    var routeButton = document.getElementById('findRoute');
    routeButton.addEventListener('click', function (event) {
        findRoutes();
        routeDistance();
    });

    function findRoutes() {
        var startCoord = startPoint.getGeometry().getCoordinates();
        var destCoord = destPoint.getGeometry().getCoordinates();
        var viewparams = [
            'x1:' + startCoord[0], 'y1:' + startCoord[1],
            'x2:' + destCoord[0], 'y2:' + destCoord[1]
        ];
        params.viewparams = viewparams.join(';');
        result = new ol.layer.Image({
            title: "routing result",
            source: new ol.source.ImageWMS({
                ratio: 1,
                url: 'http://localhost:8080/geoserver/NSAS/wms',
                params: params
            })
        });
        map.addLayer(result);
        var coord = event.coordinate;
    }

    function routeDistance() {

        var startCoord = startPoint.getGeometry().getCoordinates();
        var destCoord = destPoint.getGeometry().getCoordinates();
        var url = "http://localhost:8080/geoserver/NSAS/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=NSAS:road_line_v6_routing&viewparams=x1:" + startCoord[0] + ";y1:" + startCoord[1] + ";x2:" + destCoord[0] + ";y2:" + destCoord[1] + "&maxFeatures=50&outputFormat=text/javascript&format_options=callback:routeDistanceFeatures";
        $.ajax({
            url: url,
            dataType: 'jsonp'
        });
    }

    var routeDistanceFeatures = function (response) {
        var distanceValue = 0;
        var timeValue = 0;
        var features = (new ol.format.GeoJSON()).readFeatures(response);
        for (i = 0; i < features.length; i++) {
            distanceValue = distanceValue + Number(features[i].get('len_km'));
            //timeValue = timeValue + Number(features[i].get('drive_time'));
        }
        var timeResult = getHour(timeValue);
        if (distanceValue > 0) {
            document.getElementById('id_spanDistanceTime').innerHTML = "Distance:" + distanceValue.toFixed(3) + "km  Time:" + timeResult;
            $('#id_divDistanceTime').show();
        }
    };

    function getHour(n) {
        var num = n;
        var hours = (num / 60);
        var rhours = Math.floor(hours);
        var minutes = (hours - rhours) * 60;
        var rminutes = Math.round(minutes);
        return rhours + ":" + rminutes;
    }
    var currentSelectedTypeValue = '';
    function addLocationTypeOnMap(typevalue) {
        currentSelectedTypeValue = typevalue;
        var url = "http://localhost:8080/geoserver/NSAS/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=NSAS:bldg_final_v7&outputFormat=text/javascript&format_options=callback:loadlocationTypeFeatures&CQL_FILTER=maj_lu%3D'" + typevalue + "'";

        $.ajax({

            url: url,
            dataType: 'jsonp'

        });
    }

    var loadlocationTypeFeatures = function (response) {
        var features = (new ol.format.GeoJSON()).readFeatures(response);
        var featureCount = features.length;
        document.getElementById("id_label_" + currentSelectedTypeValue).innerHTML = this.currentSelectedTypeValue + " (" + featureCount + ")";
        locationTypeVectorSource.addFeatures(features);

        var style_admin = new ol.style.Style({
            fill: new ol.style.Fill({
                color: '#85180a'
            })
        });
        var style_CBT = new ol.style.Style({
            fill: new ol.style.Fill({
                color: '#ec2213'
            })
        });
        var style_MS = new ol.style.Style({
            fill: new ol.style.Fill({
                color: '#874aef'
            })
        });
        var style_RE = new ol.style.Style({
            fill: new ol.style.Fill({
                color: '#93d31b'
            })
        });
        var style_residence = new ol.style.Style({
            fill: new ol.style.Fill({
                color: '#eda806'
            })
        });
        var style_service = new ol.style.Style({
            fill: new ol.style.Fill({
                color: '#2484e3'
            })
        });
        var style_transport = new ol.style.Style({
            fill: new ol.style.Fill({
                color: '#f859eb'
            })
        });
        var style_defualt = new ol.style.Style({
            fill: new ol.style.Fill({
                color: 'blue'
            })
        });
        // The vector layer used to display the "start" and "destination" features.
        locationTypeVectorLayer = new ol.layer.Vector({
            source: locationTypeVectorSource
        });
        locationTypeVectorSource.forEachFeature(function (f) {
            var buildingValue = f.get('maj_lu');
            console.log(buildingValue)
            if (buildingValue == 'Administration') {
                f.setStyle(style_admin);
            }
            else if (buildingValue == 'Commerce, Business & Trade') {
                f.setStyle(style_CBT);
            }
            else if (buildingValue == 'Manufacturing and Storage') {
                f.setStyle(style_MS);
            }
            else if (buildingValue == 'Recreational and Environmental') {
                f.setStyle(style_RE);
            }
            else if (buildingValue == 'Residence') {
                f.setStyle(style_residence);
            }
            else if (buildingValue == 'services') {
                f.setStyle(style_service);
            }
            else if (buildingValue == 'Transport') {
                f.setStyle(style_transport);
            }
            // else if (buildingValue == 'NULL') {
            //   f.setStyle(style_defualt);
            // }

        });
        map.addLayer(locationTypeVectorLayer);

    };

    map.getView().on('change:resolution', function (evt) {
        var resolution = evt.target.get('resolution');
        var units = map.getView().getProjection().getUnits();
        var dpi = 25.4 / 0.28;
        var mpu = ol.proj.METERS_PER_UNIT[units];
        var scale = resolution * mpu * 39.37 * dpi;
        if (scale >= 9500 && scale <= 950000) {
            scale = Math.round(scale / 1000) + "K";
        } else if (scale >= 950000) {
            scale = Math.round(scale / 1000000) + "M";
        } else {
            scale = Math.round(scale);
        }
        document.getElementById('scale').innerHTML = "Scale = 1 : " + scale;
    });

    map.getView().fit(bounds, map.getSize());
</script>
{% endblock %}